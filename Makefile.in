##
##    Values imported from the configure script
##
top_srcdir = @top_srcdir@
top_builddir = @top_builddir@
srcdir = @srcdir@
VPATH = @srcdir@
subdir = .

## do not edit these definitions ############################################

GMP_CPPFLAGS = @GMP_CPPFLAGS@
GMP_LIBS     = @GMP_LIBS@

CC = @CC@
CFLAGS = @CFLAGS@
CPP = @CPP@
CPPFLAGS = @CPPFLAGS@
EXEEXT = @EXEEXT@
LDFLAGS = @LDFLAGS@
LIBS = @LIBS@
MKDIR_P = @MKDIR_P@
SED = @SED@
PACKAGE_VERSION = @PACKAGE_VERSION@

BINDIR  = bin/@GAPARCH@
EFILE   = $(BINDIR)/pq$(EXEEXT)

#
# The following are valid compilation flags for the program.
#
#STANDARD_PCP -- if compiling version which permits construction of
#                standard presentation
#
#GAP_LINK  -- GAP is called by pq to perform insoluble stabiliser calculations 
#
#GAP -- if compiling version for incorporation in GAP
#
#DEBUG -- debugging information is generated by a number of procedures
#
# Change features of executable
#
#RUN_TIME -- supply maximum number of defining generators and class bound 
#             at run-time  (see README file for further details)
#
#TAILS_FILTER -- apply filter for exponent 4 and 5 and max occurrences
#
#CONSISTENCY_FILTER -- apply filter for exponent 4 and 5 and max occurrences
#
#
PQFLAGS = -DGAP_LINK_VIA_FILE -DGAP -DSTANDARD_PCP -DGROUP

GAP_EXEC="gap"
#GAP_EXEC="@GAPROOT@/bin/gap.sh"
#PQFLAGS += -DANUPQ_GAP_EXEC='"$(GAP)"'
#PQFLAGS += -DANUPQ_GAP_EXEC='"@GAPROOT@/bin/gap.sh"'


# FIXME: Add prototypes for all C functions and then remove -Wno-implicit.
# FIXME: Fix all -Wall warnings
#CFLAGS   += -O2 -Wall -Wno-implicit
CFLAGS   += -O2 -Wno-implicit
CPPFLAGS += $(GMP_CPPFLAGS) -I$(top_srcdir)/include $(PQFLAGS)
LIBS     += $(GMP_LIBS)

## Command used to start up GAP4

SRC=$(srcdir)/src
PKGNAME=anupq

all: $(EFILE) testPq

testPq: testPq.in
	$(SED) \
	  -e "s/\@GAPARCH\@/@GAPARCH@/g" \
	  -e "s/\@PACKAGE_VERSION\@/@PACKAGE_VERSION@/g" \
	  -e "s|\@GAP_EXEC\@|$(GAP_EXEC)|g" \
	  < $< > $@
	chmod +x $@

## show makefile options ####################################################


## load list of object files ################################################
include Makefile.objs


## do the linking and put the executable in the right place #################
$(EFILE): $(OBJECTS)
	$(MKDIR_P) $(BINDIR)
	$(CC) -o $@ $(OBJECTS) $(LIBS) $(LDFLAGS)

## clean me up ##############################################################
clean:
	rm -f $(OBJECTS) $(SRC)/core*
	rm -rf $(BINDIR)
	(cd doc && rm -f *.aux *.bbl *.blg *.brf *.idx *.ilg *.ind *.log *.out *.pnr *.toc)
	(cd standalone-doc && rm -rf *.aux *.log *.toc)

distclean: clean
	rm -f Makefile testPq $(top_builddir)/config.status
	rm -rf standalone/bin
	rm -f include/config.h include/config.hin~
	rm -f config.cache config.log config.status


## regenerate Makefile etc. if necessary #####################################
.PRECIOUS: Makefile
Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
	cd $(top_builddir) && $(SHELL) ./config.status $@

$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
	$(SHELL) ./config.status --recheck

$(top_srcdir)/configure: $(top_srcdir)/configure.ac
	cd $(top_srcdir) && autoreconf

## move directories around to how GAP4 likes them ###########################
# FIXME: Do we still need this?
GAP4remapdirs:
	if test -d standalone-doc; then \
	echo "directories already remapped for GAP4?!?"; fi
	if test ! -d standalone-doc; then \
	mv README doc; mv doc standalone-doc; \
	$(MKDIR_P) -m 755 standalone/bin; mv TEST examples isom standalone; \
	(cd gap; mv README configure replace Makefile.in init.g read.g doc ..;\
	 mv examples tst lib ..;)\
	fi

## move directories from how GAP4 likes them to the generic layout ##########
# FIXME: Do we still need this?
restoredirs:
	if test -d gap/doc; then echo "directories already restored?!?"; fi
	if test ! -d gap/doc; then \
	$(MAKE) -f Makefile clean; \
	$(MKDIR_P) -m 755 gap; \
	mv examples tst lib gap; \
	mv README configure replace Makefile.in init.g read.g doc gap; \
	(cd standalone; mv examples isom TEST ..) \
	mv standalone-doc doc; mv doc/README .; \
	fi

## create object list for the Makefile ######################################
objectlist:
	@( ls -1 $(SRC)/*.c ) | \
	$(SED) s/\\.c$$/\\.o/ | \
	( echo "OBJECTS=\\"; \
	  awk '{printf( "\t%-30s%s", $$0, "\\\n")}'; \
	  echo ""; echo "" ) > Makefile.objs

## create dependency list for the Makefile ##################################
depend:
	@echo Updating dependencies...
	@echo "# GENERATED FILE, DO NOT EDIT MANUALLY" > Makefile.deps
	@for i in $(OBJECTS) ; do \
	  j=`basename $$i .o` ; \
	  gcc -MM -MP -MQ $$i  $(CPPFLAGS) $(PQFLAGS) $(SRC)/$$j.c >> Makefile.deps ; \
	done
	@echo Done!

.PHONY: all clean distclean GAP4remapdirs restoredirs objectlist depend

## load dependency list for the Makefile ####################################
-include Makefile.deps
